const injectIoc = require('../util/injectIoc');
/**
* 计算当前用户是连续第几天签到
* @param { string } tag - 签到项目 ID
* @param { string } wxOpenId - 微信 openid
* @returns { number } 返回当前是第几天，eg 1代表连续1天签到
*/
module.exports = async (tag, wxOpenId) => {
  const { services: { tcbService: { db }, loggerService, tcloudRequestService } } = injectIoc();
  const [userSignin] = await tcloudRequestService.getDsColName(['signList_25nwfab']);
  const getSignInDay = async (tag) => {
    const { data } = await db.collection(userSignin).where({ openId: wxOpenId, isContinuous: true, tag })
      .orderBy('day', 'desc')
      .limit(1)
      .get();
    loggerService.info({ content: '连续签到第几天：', data, wxOpenId, tag });
    if (data && data.length > 0) {
      return data[0].day;
    }
    return 0;
  };
  return await getSignInDay(tag);
};

