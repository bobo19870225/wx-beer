const injectIoc = require('../util/injectIoc');
const lodash = require('lodash');
const { CATEGORY_COL_NAME, CONFIG_COL_NAME } = require('../constant/db');
const { INLINE_CATEGORY_LIST, INLINE_CATEGORY_CREATED_KEY } = require('../constant/category');
const getDsColName = require('./getDsColName');

/**
 * 自动检测并创建内置分类
 */
module.exports = async () => {
  const { services: { tcbService: { db }, utilService } } = injectIoc();
  const [configColName, catColName] = await getDsColName([CONFIG_COL_NAME, CATEGORY_COL_NAME]);
  const { data: configData } = await db.collection(configColName)
    .where({ configKey: INLINE_CATEGORY_CREATED_KEY })
    .get();
  if (configData.length && lodash.get(configData[0], 'configVal') === true) {
    return;
  }

  const now = utilService.getLocalDayjs().valueOf();
  const inlineCategory = INLINE_CATEGORY_LIST.map(item => ({
    ...item,
    createdAt: now,
    updatedAt: now,
  }));
  const trans = await db.startTransaction();
  await trans.collection(configColName)
    .add({
      configKey: INLINE_CATEGORY_CREATED_KEY,
      configVal: true,
    });
  await trans.collection(catColName)
    .add(inlineCategory);
  await trans.commit();
};
