const injectIoc = require('../util/injectIoc');
const { CLOUD_API_ERR } = require('./../constant/errcode');
const lodash = require('lodash');

/**
 * @typedef {object} WxAppInfo
 * @property {string} uin - 腾讯云uin
 * @property {string} nickName - 小程序名称
 * @property {string} wxAppId - 小程序ID
 */

/**
 * 获取腾讯云低码绑定的小程序
 * @returns {Array<WxAppInfo>}
 */
module.exports = async () => {
  const {
    services: { tcloudRequestService, errService },
  } = injectIoc();
  try {
    const res = await tcloudRequestService.requestV3({
      service: 'lowcode',
      action: 'DescribeWxAppInfo',
      actionParams: {},
    });
    const list = lodash.get(res, 'Response.WxAppInfos') || [];
    return list.map(item => ({
      uin: item.Uin,
      nickName: item.NickName,
      wxAppId: item.WxAppId,
    }));
  } catch (error) {
    errService.throw(CLOUD_API_ERR, `获取低码绑定小程序失败:${error.message}`);
  }
};
