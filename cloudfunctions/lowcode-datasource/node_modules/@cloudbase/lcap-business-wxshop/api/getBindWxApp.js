const injectIoc = require('../util/injectIoc');
const lodash = require('lodash');
const { CONFIG_COL_NAME } = require('./../constant/db');
const { WX_APP_NOT_EXIST } = require('./../constant/errcode');
const { BIND_WXAPP_KEY } = require('./../constant/config');
const getDsColName = require('./getDsColName');
/**
 * 获取绑定的微信小程序
 */
module.exports = async () => {
  const { services: { tcbService: { db }, errService } } = injectIoc();
  const [configColName] = await getDsColName([CONFIG_COL_NAME]);
  const configRes = await db.collection(configColName)
    .where({ configKey: BIND_WXAPP_KEY })
    .get();
  const wxAppId = lodash.get(configRes, 'data[0].configVal', null);
  if (!wxAppId) {
    errService.throw(WX_APP_NOT_EXIST, '微信小程序未绑定，请前往电商管理端绑定');
  }
  return wxAppId;
};
