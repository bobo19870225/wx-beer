const lodash = require('lodash');
const injectIoc = require('../util/injectIoc');
const { WX_TOKEN_FAIL } = require('./../constant/errcode');

/**
 * 获取小程序开发 token
 * @param {string} wxAppId 微信小程序ID
 * @returns {string}
 */
module.exports = async (wxAppId) => {
  const {
    services: {
      tcloudRequestService,
      errService,
    },
  } = injectIoc();
  try {
    const res = await tcloudRequestService.requestV3({
      service: 'lowcode',
      action: 'DescribeWxAccessToken',
      actionParams: Object.assign({
        WxAppId: wxAppId,
      }),
    });
    if (lodash.get(res, 'Response.AccessToken')) {
      return res.Response.AccessToken;
    }
    throw new Error('Response.AccessToken 为空');
  } catch (error) {
    errService.throw(WX_TOKEN_FAIL, error.message);
  }
};
