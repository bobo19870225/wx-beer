const { LcapContainer } = require('@cloudbase/lcap-business-sdk');
const lodash = require('lodash');

/**
 * 判断是否为 LcapContainer 实例。
 * 注意：仅靠 instanceof 会判断失败，配合原型链进行判断。
 * @param {any} ins
 * @returns {boolean}
 */
function isLcapContainer(ins) {
  return ins instanceof LcapContainer || lodash.get(ins, '__proto__.constructor.name') === 'LcapContainer';
}

let ioc;
/**
 * injectIoc入参
 * @typedef {object} InjectIocParams
 * @property {string} [context] - 上下文环境
 * @property {LcapContainer} [container] - 已初始化的ioc
 */

/**
 * 注入 Ioc 容器（全局缓存）
 * @param {InjectIocParams} params
 * @returns {LcapContainer}
 */
function injectIoc(params = {}) {
  if (isLcapContainer(ioc)) {
    return ioc;
  }

  const { context, container } = params;
  if (isLcapContainer(container)) {
    ioc = container;
  } else {
    ioc = new LcapContainer({
      lcDatasourceCtx: context,
    });
  }
  return ioc;
}

module.exports = injectIoc;
